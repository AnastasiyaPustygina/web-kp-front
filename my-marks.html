<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>–ú–æ–∏ –æ—Ü–µ–Ω–∫–∏</title>
    <link rel="stylesheet" href="/css/profile.css" />
</head>
<body>
<main class="profile-section">
    <h2 class="page-title">–ú–æ–∏ –æ—Ü–µ–Ω–∫–∏</h2>

    <div id="ratings-list"></div>
</main>
<nav class="bottom-nav" role="navigation" aria-label="–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
    <button onclick="goToList()" aria-label="–°–ø–∏—Å–æ–∫" class="nav-item" type="button" tabindex="0">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zm0-10v2h14V7H7z"/></svg>
        <span>–°–ø–∏—Å–æ–∫</span>
    </button>
    <button onclick="goToHistory()" aria-label="–ò—Å—Ç–æ—Ä–∏—è" class="nav-item" type="button" tabindex="0">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M13 3a9 9 0 1 0 9 9h-2a7 7 0 1 1-7-7V3z"/><path d="M12 7h1v5h-4v-1h3z"/></svg>
        <span>–ò—Å—Ç–æ—Ä–∏—è</span>
    </button>
    <button onclick="goToFind()" aria-label="–ü–æ–∏—Å–∫" class="nav-item" type="button" tabindex="0">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 001.48-5.34C15.07 5.61 12.28 3 8.5 3S2 5.61 2 9.5 5.22 16 9 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zM9 14c-2.49 0-4.5-2.01-4.5-4.5S6.51 5 9 5s4.5 2.01 4.5 4.5S11.49 14 9 14z"/></svg>
        <span>–ü–æ–∏—Å–∫</span>
    </button>
    <button onclick="goToFavourites()" aria-label="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ" class="nav-item" type="button" tabindex="0">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 6 3.99 4 6.5 4 8 4 9.5 5 10 6.09 10.5 5 12 4 13.5 4c2.51 0 4.5 2 4.5 4.5 0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
        <span>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
    </button>
    <button aria-label="–ü—Ä–æ—Ñ–∏–ª—å" class="nav-item active" type="button" tabindex="0">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v3h20v-3c0-3.3-6.7-5-10-5z"/></svg>
    </button>
</nav>
<script src="js/navigation.js"></script>

<script>
    const consumer = JSON.parse(localStorage.getItem('user'));
    const userId = consumer?.id;
    const favoriteIds = consumer?.favourite_recipe_ids || [];

    fetch(`http://127.0.0.1:5000/marks/consumer/${userId}`)
        .then(res => res.json())
        .then(marks => {
            const container = document.getElementById('ratings-list');
            if (!marks || marks.length === 0) {
                container.innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫</p>';
                return;
            }

            marks.forEach(mark => {
                const card = document.createElement('div');
                card.className = 'review-card';
                container.appendChild(card);

                fetch(`http://127.0.0.1:5000/recipes/${mark.recipe_id}`)
                    .then(res => res.json())
                    .then(recipe => {
                        const isFavorite = favoriteIds.includes(recipe.id);
                        card.innerHTML = `
                            <div class="review-img">
                                <img src="${recipe.image_url || 'placeholder.jpg'}" alt="${recipe.title}" />
                            </div>
                            <div class="review-content">
                                <div class="review-header">
                                    <h3>${recipe.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h3>
                                    <button class="like-btn" data-recipe-id="${recipe.id}">${isFavorite ? '‚ù§Ô∏è' : 'ü§ç'}</button>
                                    </button>
                                </div>
                                <div class="brief-info">
                                    <span>–ü–æ—Ä—Ü–∏–∏: ${recipe.count_portion || '‚Äî'}</span>
                                    <span>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã: ${recipe.count_views || '‚Äî'}</span>
                                </div>
                                <div class="stars" id="stars-${mark.id}">
                                    ${'‚òÖ'.repeat(mark.value)}${'‚òÜ'.repeat(5 - mark.value)}
                                </div>
                                <p class="meta">–û—Ü–µ–Ω–µ–Ω–æ: ${new Date(mark.date_time).toLocaleDateString()}</p>
                                <div class="review-actions">
                                    <button class="edit-rating" data-mark-id="${mark.id}" data-recipe-id="${mark.recipe_id}" data-current-value="${mark.value}">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫—É</button>
                                    <button class="delete-rating" data-mark-id="${mark.id}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –æ—Ü–µ–Ω–∫—É</button>
                                </div>
                            </div>
                        `;
                        card.addEventListener('click', (e) => {window.location.href=`recipe.html?id=${recipe.id}`})
                        const heartBtn = card.querySelector('.like-btn');
                        heartBtn.addEventListener('click', async () => {
                            const recipeId = parseInt(heartBtn.dataset.recipeId);
                            const isCurrentlyFavorite = favoriteIds.includes(recipeId);
                            const method = isCurrentlyFavorite ? 'DELETE' : 'POST';

                            try {
                                const response = await fetch(`http://127.0.0.1:5000/consumers/${consumer.id}/favorites/${recipeId}`, {
                                    method,
                                    headers: { 'Content-Type': 'application/json' }
                                });

                                const data = await response.json();

                                if (data.success) {
                                    consumer.favourite_recipe_ids = data.favourite_recipe_ids;
                                    localStorage.setItem('consumer', JSON.stringify(consumer));
                                    heartBtn.innerHTML = data.action === 'added' ? '‚ù§Ô∏è' : 'ü§ç';
                                } else {
                                    alert(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
                                }
                            } catch (error) {
                                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', error);
                                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
                            }
                        });
                    })
                    .catch(err => {
                        card.innerHTML = `<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Ü–µ–ø—Ç–∞: ${err.message}</p>`;
                    });
            });
        })
        .catch(err => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ü–µ–Ω–æ–∫:', err);
            document.getElementById('ratings-list').innerHTML = '<p>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ü–µ–Ω–æ–∫</p>';
        });

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫
    document.addEventListener('click', function(event) {
        const editBtn = event.target.closest('.edit-rating');
        const deleteBtn = event.target.closest('.delete-rating');

        // ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏
        if (editBtn) {
            const markId = editBtn.dataset.markId;
            const recipeId = editBtn.dataset.recipeId;
            const currentValue = parseInt(editBtn.dataset.currentValue);

            const newValue = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –æ—Ü–µ–Ω–∫—É (–æ—Ç 1 –¥–æ 5):', currentValue);

            if (newValue && !isNaN(newValue)) {
                const numValue = parseInt(newValue);
                if (numValue >= 1 && numValue <= 5) {
                    fetch(`http://127.0.0.1:5000/marks/${markId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ value: numValue })
                    })
                        .then(res => {
                            if (res.ok) {
                                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–≤—ë–∑–¥
                                const starsElement = document.getElementById(`stars-${markId}`);
                                if (starsElement) {
                                    starsElement.innerHTML = '‚òÖ'.repeat(numValue) + '‚òÜ'.repeat(5 - numValue);
                                    editBtn.dataset.currentValue = numValue;
                                }
                            } else {
                                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ—Ü–µ–Ω–∫–∏');
                            }
                        })
                        .catch(() => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.'));
                } else {
                    alert('–û—Ü–µ–Ω–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 1 –¥–æ 5');
                }
            }
        }

        // üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏
        if (deleteBtn) {
            const markId = deleteBtn.dataset.markId;

            if (confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ü–µ–Ω–∫—É?')) {
                fetch(`http://127.0.0.1:5000/marks/${markId}`, { method: 'DELETE' })
                    .then(res => {
                        if (res.ok) {
                            deleteBtn.closest('.review-card')?.remove();
                        } else {
                            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ—Ü–µ–Ω–∫–∏');
                        }
                    })
                    .catch(() => alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏.'));
            }
        }
    });
</script>
</body>
</html>